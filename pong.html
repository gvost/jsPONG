<!DOCTYPE html>

<html>
  <head>
    <style>
      body {
        background-color: grey;
      }

      #container {
        background-color: black;
        width: 800px;
        height: 468px;
        cursor: pointer;
        border: 1px solid #f6eb16;
        padding: 10px;
        margin: 0 auto;
      }

      canvas {
        background-color: black;
        border-top: 4px solid #2AAAE2;
        border-bottom: 4px solid #2AAAE2;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
  </body>
</html>

<script>
  
  // canvas height and width
  var width = 800;  
  var height = 460; 

  // create the canvas 
  var container = document.getElementById("container");
  var canvas = document.createElement('canvas');
  container.appendChild(canvas);
  canvas.width = width;
  canvas.height = height;
  var ctx = canvas.getContext('2d');

  var requestAnimationFrame = 
    window.requestAnimationFrame || 
    window.mozRequestAnimationFrame || 
    window.webkitRequestAnimationFrame || 
    window.msRequestAnimationFrame;

  // initialize ball
  var ballSize = 7.5;
  ctx.fillStyle = "white";
  var x;
  var y;
  var dx;
  var dy;
  var ballSpeed;
  resetBall();

  var paddleWidth = 11;
  var paddleHeight = 62;
  var paddleSpeed = 6;

  function Paddle() {
    this.pdx = 0;
    this.pdy = 0;
  }

  Paddle.prototype.reset = function(x, y) {
    this.pX = x;
    this.pY = y;
  }

  Paddle.prototype.update = function() {
    this.pX += this.pdx * paddleSpeed;
    this.pY += this.pdy * paddleSpeed;
  }

  Paddle.prototype.draw = function() {
    ctx.fillStyle = "#f6eb16"
    ctx.fillRect(this.pX, this.pY, paddleWidth, paddleHeight);   
  }

  var userPaddle = new Paddle();
  var CPUPaddle = new Paddle();
  userPaddle.reset(width - 10 - paddleWidth, (height / 2) - (paddleHeight / 2));
  CPUPaddle.reset(10, (height / 2) - (paddleHeight / 2));

  CPUPaddle.predict = function() {
    if (y > this.pY + (paddleHeight / 2) && dx < 0) {
      this.pdy = 1;
    } else if (y < this.pY + (paddleHeight / 2) && dx < 0) {
      this.pdy = -1;
    } else {
      this.pdy = 0;
    }
  }

  var RAF = requestAnimationFrame(play)

  // main loop
  function play() {

    // clear the canvas
    ctx.clearRect(0, 0 , width, height);

    // draw the mid-line
    ctx.beginPath();
    ctx.moveTo(width / 2, 0);
    ctx.lineTo(width / 2, height);
    ctx.strokeStyle = "#2AAAE2";
    ctx.stroke();

    userPaddle.draw();
    userPaddle.update();

    if (userPaddle.pY > height - paddleHeight) {
      userPaddle.pdy = 0;
      userPaddle.pY = height - paddleHeight;
    } else if (userPaddle.pY < 0) {
      userPaddle.pdy = 0;
      userPaddle.pY = 0;
    }

    CPUPaddle.draw();
    CPUPaddle.predict();
    CPUPaddle.update();

    // draw the ball
    ctx.beginPath();
    ctx.arc(x, y, ballSize, 0, 2 * Math.PI, false);
    ctx.fillStyle = "#ffffff";
    ctx.fill();
    ctx.stroke();

    // move the ball
    x += dx * ballSpeed;
    y += dy * ballSpeed;

    // detect ball collision with top or bottom
    if (y > height - ballSize) {
      dy *= -1;
    } else if (y < ballSize) {
      dy *= -1;
    }

    // detect ball/userPaddle collision
    if (y > userPaddle.pY && y < userPaddle.pY + paddleHeight && x + ballSize > userPaddle.pX) {
      if (userPaddle.pdy == 0) {
        dx = -1;
      } else {
        dx = -1;
        dy *= 1.2;
      }
    }

    // detect ball/CPUPaddle collision
    if (y > CPUPaddle.pY && y < CPUPaddle.pY + paddleHeight && x - ballSize < CPUPaddle.pX + paddleWidth)
      dx = 1;

    // detect points
    if (x > width + ballSize) {
      //detect point for computer
      stopGame();
    } else if (x < -1 * ballSize) {
      //detect point for user
      stopGame();
    } else {
      RAF = requestAnimationFrame(play);
    }

  };

  var key_detector = (function () {
    var map = []; 

    onkeydown = onkeyup = function(e) {
      e = e || event; // to deal with IE
      map[e.keyCode] = (e.type == 'keydown');
      updateDirection();
   //   console.log("map = ", map);
    }

    // a = 65 d = 68
    // s = 83  w = 87
    // left arrow = 37
    // right arrow = 39

    function updateDirection() {
      if (map[37]) {
        userPaddle.pdx = -1;
      } else if (map[39]) {
        userPaddle.pdx = 1;
      } else {
        userPaddle.pdx = 0;
      }

      if (map[38]) {
        userPaddle.pdy = -1;
      } else if (map[40]) {
        userPaddle.pdy = 1;
      } else {
        userPaddle.pdy = 0;
      }
    }

  })();

  function resetBall() {
    x = width / 2;
    y = height / 2;
    dx = 1;
    dy = 1;
    ballSpeed = 5;
  }

  function startGame() {
    RAF = requestAnimationFrame(play);    
  }

  function stopGame() {
    console.log("game stopped");
    resetBall();
  }

  canvas.onclick = function() {
    startGame();
  }

</script>